@using System.Drawing;
@using System.Drawing.Imaging;
@using Net.Codecrete.QrCodeGenerator;
@using System.Text;

@if (!string.IsNullOrEmpty(QrCodeSVG))
{
    <div class="popupDiv popupZIndex_0" style="height: fit-content; width: 80%; left: 10%;">
        <div class="col">

            <div class="row mb-5">
                <div class="col d-flex justify-content-start" style="font-size: large; font-weight: bold;">
                    QR Code
                </div>

                <div class="col d-flex justify-content-end">
                    <button style="padding: 3px 10px; height: fit-content;" @onclick="() => { QrCodeSVG = string.Empty; }">X</button>
                </div>
            </div>

            <div class="row mb-5">
                <div class="d-flex justify-content-center">
                    <div class="svgContainer">
                        @((MarkupString)QrCodeSVG)
                    </div>
                </div>
            </div>

        </div>
    </div>
}

@code {
    public string QrCodeSVG { get; set; } = "";

    public void GenerateQRCode(string text)
    {
        var qrCode = QrCode.EncodeText(text, QrCode.Ecc.Medium);

        var size = 300;

        var sb = new StringBuilder();

        sb.AppendLine($"<svg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\" viewBox=\"0 0 {size} {size}\" preserveAspectRatio=\"xMidYMid meet\" shape-rendering=\"crispEdges\">");
        sb.AppendLine("<rect width=\"100%\" height=\"100%\" fill=\"white\"/>");

        var scale = size / qrCode.Size;
        for (int y = 0; y < qrCode.Size; y++)
        {
            for (int x = 0; x < qrCode.Size; x++)
            {
                if (qrCode.GetModule(x, y))
                {
                    sb.AppendLine($"<rect x=\"{x * scale}\" y=\"{y * scale}\" width=\"{scale}\" height=\"{scale}\" fill=\"black\"/>");
                }
            }
        }

        sb.AppendLine("</svg>");

        QrCodeSVG = sb.ToString();

        StateHasChanged();
    }
}
